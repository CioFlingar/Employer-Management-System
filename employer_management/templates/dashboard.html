{% extends 'base.html' %}
{% block content %}
<div x-data="{
  showEmployerForm: false,
  selectedEmployer: null,
  companyName: '', contactPersonName: '', emailEmployer: '', phoneNumber: '', address: '',
  error: '', employers: []
}" x-init="fetchEmployers()">
  <nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Employer Management</h1>
    <button @click="handleLogout()" class="bg-red-500 p-2 rounded hover:bg-red-600">Logout</button>
  </nav>
  <div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-4">Employers</h2>
    <button @click="showEmployerForm = true; selectedEmployer = null" class="mb-4 bg-green-500 text-white p-2 rounded hover:bg-green-600">Add Employer</button>
    <div id="employer-list" hx-get="{% url 'employers:employer-list' %}" hx-trigger="load, every 5s" hx-headers='{"Authorization": "Bearer " + localStorage.getItem("accessToken")}' hx-target="#employer-list">
      <template x-for="employer in employers" :key="employer.id">
        <div class="flex justify-between items-center bg-white p-4 rounded shadow my-2">
          <span x-text="employer.company_name + ' - ' + employer.email"></span>
          <div>
            <button @click="selectedEmployer = employer; showEmployerForm = true; companyName = employer.company_name; contactPersonName = employer.contact_person_name; emailEmployer = employer.email; phoneNumber = employer.phone_number; address = employer.address" class="mr-2 bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Edit</button>
            <button @click="handleDelete(employer.id)" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">Delete</button>
          </div>
        </div>
      </template>
      <p x-show="employers.length === 0" class="text-gray-500">No employers found.</p>
    </div>
    <div x-show="showEmployerForm" x-cloak>
      <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4" x-text="selectedEmployer ? 'Edit Employer' : 'Add Employer'"></h2>
        <p x-show="error" class="text-red-500 mb-4" x-text="error"></p>
        <form @submit.prevent="
          var method = selectedEmployer ? 'PUT' : 'POST';
          var url = selectedEmployer ? '/api/employers/' + selectedEmployer.id + '/' : '/api/employers/';
          fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
            },
            body: JSON.stringify({ company_name: companyName, contact_person_name: contactPersonName, email: emailEmployer, phone_number: phoneNumber, address: address })
          })
          .then(response => {
            if (response.ok) {
              error = '';
              showEmployerForm = false;
              selectedEmployer = null;
              companyName = '';
              contactPersonName = '';
              emailEmployer = '';
              phoneNumber = '';
              address = '';
              fetchEmployers();
            } else {
              error = 'Failed to save employer';
            }
          })
          .catch(() => { error = 'Failed to save employer'; })
        " class="space-y-4">
          <input type="text" x-model="companyName" placeholder="Company Name" class="w-full p-2 border rounded" required>
          <input type="text" x-model="contactPersonName" placeholder="Contact Person Name" class="w-full p-2 border rounded" required>
          <input type="email" x-model="emailEmployer" placeholder="Email" class="w-full p-2 border rounded" required>
          <input type="text" x-model="phoneNumber" placeholder="Phone Number" class="w-full p-2 border rounded" required>
          <textarea x-model="address" placeholder="Address" class="w-full p-2 border rounded" required></textarea>
          <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600" x-text="selectedEmployer ? 'Update' : 'Add'"></button>
          <button type="button" @click="showEmployerForm = false; selectedEmployer = null" class="w-full mt-2 bg-red-500 text-white p-2 rounded hover:bg-red-600">Cancel</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    function fetchEmployers() {
      fetch('/api/employers/', {
        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') }
      })
      .then(response => response.json())
      .then(data => this.employers = data)
      .catch(error => console.error('Error fetching employers:', error));
    }

    function handleDelete(id) {
      if (confirm('Are you sure?')) {
        fetch('/api/employers/' + id + '/', {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') }
        })
        .then(response => {
          if (response.ok) fetchEmployers.call(this);
        })
        .catch(error => console.error('Error deleting employer:', error));
      }
    }

    function handleLogout() {
      var refreshToken = prompt('Enter your refresh token to logout:');
      if (refreshToken) {
        fetch('/api/auth/logout/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh: refreshToken })
        })
        .then(response => {
          if (response.ok) {
            localStorage.removeItem('accessToken');
            window.location.href = '/login/';
          }
        })
        .catch(error => console.error('Error logging out:', error));
      }
    }
  </script>
</div>
{% endblock %}